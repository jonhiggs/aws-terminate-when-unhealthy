#!/bin/bash
source `dirname $0`/../lib/as.inc
source `dirname $0`/../lib/elb.inc
source `dirname $0`/../lib/service.inc
source `dirname $0`/../lib/system.inc

INFO='true'
DRY_RUN='true'
INSTANCE_ID=`systemGetMeta instance-id`
ELB="test-lb"
AS="test-as"
SERVICE_FILE="/tmp/last_in_service"
OUT_OF_SERVICE_THRESHOLD=60                 # shut down instance if it's been out of service for over 60 seconds.
OUT_OF_SERVICE_PRECAUTION_THRESHOLD=10      # spin up another instance as a precaution if its been offline for 10 seconds.
ELB_TMP_FILE=`mktemp -t terminate_test_elb.XXXXX`
AS_TMP_FILE=`mktemp -t terminate_test_as.XXXXX`
START_TIME=`date +%s`

if ! elbPrimeData; then systemCleanUp; exit 1; fi
if ! asPrimeData; then systemCleanUp; exit 1; fi
if ! asMember; then systemCleanUp; exit 0; fi
if ! elbMember; then systemCleanUp; exit 0; fi


while elbOutOfService; do
  if serviceMaybeOutOfService; then
    asAddInstance
    sleep `serviceRetryInterval`
  fi

  if serviceOutOfService; then
    asRemoveInstance
    # send email
    exit 0
  fi

  systemInfo "$INSTANCE_ID is out of service. Sleeping to see what happens."
  sleep `serviceRetryInterval`
done

serviceUpdateTimeLastHealthy
systemCleanUp

# vim: ai ts=2 sw=2 et sts=2 ft=sh
