#!/bin/bash
source `dirname $0`/../lib/as.inc
source `dirname $0`/../lib/elb.inc
source `dirname $0`/../lib/service.inc
source `dirname $0`/../lib/system.inc

INFO='true'
DRY_RUN='true'
INSTANCE_ID=`systemGetMeta instance-id`
ELB="test-lb"
AS="test-as"
SERVICE_FILE="/tmp/last_in_service"
OUT_OF_SERVICE_THRESHOLD=1200                 # shut down instance if it's been out of service for over 20 minutes.
OUT_OF_SERVICE_PRECAUTION_THRESHOLD=300       # spin up another instance as a precaution if its been offline for 5 minutes.
ELB_TMP_FILE=`mktemp -t terminate_test_elb.XXXXX`
AS_TMP_FILE=`mktemp -t terminate_test_as.XXXXX`

if ! elbPrimeData; then systemCleanUp; exit 1; fi
if ! asPrimeData; then systemCleanUp; exit 1; fi
if ! asMember; then systemCleanUp; exit 0; fi
if ! elbMember; then systemCleanUp; exit 0; fi

if serviceMaybeOutOfService; then asAddInstance; fi

while serviceMaybeOutOfService; do
  if serviceOutOfService; then
    asRemoveInstance
    # send email
    exit 0
  fi
  sleep 120
done

serviceUpdateTimeLastHealthy
systemCleanUp

# vim: ai ts=2 sw=2 et sts=2 ft=sh
